# Frontend Data Migration Walkthrough

This walkthrough documents the migration of the Tek-Mag frontend from mock data to real backend API integration using `@tanstack/react-query`.

## Changes Implemented

### 1. API Client & Interceptors
- **File**: [src/lib/api/client.ts](file:///home/amine/coding/web/tek-mag/frontend/src/lib/api/client.ts), [src/lib/api/interceptors.ts](file:///home/amine/coding/web/tek-mag/frontend/src/lib/api/interceptors.ts)
- **Change**: Configured `axios` with JWT authentication and refresh token logic. Resolved circular dependency issues.

### 2. Type Definitions
- **File**: [src/types/common.ts](file:///home/amine/coding/web/tek-mag/frontend/src/types/common.ts), [src/types/product.ts](file:///home/amine/coding/web/tek-mag/frontend/src/types/product.ts)
- **Change**: Updated TypeScript interfaces to match Django REST Framework serializer outputs.
    - [Repair](file:///home/amine/coding/web/tek-mag/frontend/src/types/common.ts#61-96): Added optional fields like `status`, `payments`, `deviceType` to match frontend usage.
    - [StockItem](file:///home/amine/coding/web/tek-mag/backend/apps/tech/models/stock_item.py#5-33): Added nested [product](file:///home/amine/coding/web/tek-mag/backend/apps/accounts/management/commands/generate_test_data.py#318-383) details.
    - [Client](file:///home/amine/coding/web/tek-mag/frontend/src/types/common.ts#51-52): Aligned with [User](file:///home/amine/coding/web/tek-mag/frontend/src/types/common.ts#41-50) model (username, first_name, last_name, profile).

### 3. React Query Hooks
- **File**: `src/hooks/`
- **Change**: Created hooks for fetching and mutating data.
    - [useRepairs](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-repairs.ts#30-37), [useRepair](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-repairs.ts#38-45), [useCreateRepair](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-repairs.ts#46-55), [useUpdateRepair](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-repairs.ts#56-66)
    - [useStockItems](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-stock-items.ts#15-22), [useUpdateStockItem](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-stock-items.ts#23-32)
    - [useClients](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-clients.ts#11-18)
    - [useProducts](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-products.ts#10-17), [useBrands](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-brands.ts#10-16), [useDeviceTypes](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-device-types.ts#10-16), [useProductModels](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-product-models.ts#11-18)

### 4. Component Integration
- **Repairs Page** (`src/app/(dashboard)/repairs/page.tsx`):
    - Replaced mock data with [useRepairs](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-repairs.ts#30-37).
    - Implemented mutations for:
        - Status changes ([handleStatusChange](file:///home/amine/coding/web/tek-mag/frontend/src/app/%28dashboard%29/repairs/page.tsx#36-68))
        - Scheduling ([handleSchedule](file:///home/amine/coding/web/tek-mag/frontend/src/app/%28dashboard%29/repairs/page.tsx#69-88))
        - Adding payments ([handleAddPayment](file:///home/amine/coding/web/tek-mag/frontend/src/app/%28dashboard%29/repairs/page.tsx#89-121))
        - Marking as recovered ([handleMarkRecovered](file:///home/amine/coding/web/tek-mag/frontend/src/app/%28dashboard%29/repairs/page.tsx#132-151))
- **Stock Page** (`src/app/(dashboard)/stock/page.tsx`):
    - Replaced mock data with [useStockItems](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-stock-items.ts#15-22).
    - Implemented stock quantity update ([handleAddStock](file:///home/amine/coding/web/tek-mag/frontend/src/components/features/stock/stock-table.tsx#22-30)).
- **Add Reparation Form** ([src/components/add-reparation/add-reparation-form.tsx](file:///home/amine/coding/web/tek-mag/frontend/src/components/add-reparation/add-reparation-form.tsx)):
    - Replaced mock data with [useBrands](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-brands.ts#10-16), [useDeviceTypes](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-device-types.ts#10-16), [useProductModels](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-product-models.ts#11-18), [useClients](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-clients.ts#11-18).
    - Fixed type mismatches and logic for dynamic filtering.

## Verification Steps

### 1. Backend Setup
Ensure the Django backend is running:
```bash
cd backend
make run-backend
```

### 2. Frontend Setup
Ensure the Next.js frontend is running:
```bash
cd frontend
npm run dev
```

### 3. Manual Verification

#### Repairs
1.  Navigate to `/repairs`.
2.  Verify the list of repairs loads from the backend.
3.  Click on a repair to view details.
4.  Change the status of a repair (e.g., from "saisie" to "en-cours"). Verify the toast success message and list update.
5.  Add a payment to a repair. Verify the payment totals update.

#### Stock
1.  Navigate to `/stock`.
2.  Verify the list of stock items loads.
3.  Click the "+" button on a stock item to add quantity. Verify the quantity updates.

#### Add Reparation
1.  Navigate to `/add-reparation` (or click "Nouvelle RÃ©paration").
2.  Verify that Device Types, Brands, and Models load from the backend.
3.  Select a client from the search (or create a new one).
4.  Submit the form (Note: [useCreateRepair](file:///home/amine/coding/web/tek-mag/frontend/src/hooks/use-repairs.ts#46-55) integration in the parent page might need final verification if not fully linked yet, but the form component itself is ready).

## Known Limitations
- **Archived Repairs**: Currently empty as the backend endpoint for archived repairs is not yet integrated.
- **Delete Payment**: Not supported by the current backend model (only totals are stored).
